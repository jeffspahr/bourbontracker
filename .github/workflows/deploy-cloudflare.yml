name: Deploy to Cloudflare Pages

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  push:
    branches:
      - main
    paths:
      - 'index.html'
      - 'favicon.svg'
      - 'logo-icon.svg'
      - '.github/workflows/deploy-cloudflare.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      # NC scraper temporarily disabled - website structure changed
      # - name: Build NC scraper
      #   run: go build -o nc-scraper ./cmd/nc-scraper
      #
      # - name: Scrape NC product list
      #   run: ./nc-scraper -output nc-products.json
      #   timeout-minutes: 5

      - name: Build tracker
        run: go build -o tracker ./cmd/tracker

      - name: Download previous inventory for caching
        uses: dawidd6/action-download-artifact@v11
        with:
          workflow: deploy-cloudflare.yml
          workflow_conclusion: success
          name_is_regexp: true
          name: inventory-.*
          path: .
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Use most recent inventory if multiple found
        run: |
          # If multiple inventory files were downloaded, use the most recent
          if ls inventory-*/inventory-*.json 1> /dev/null 2>&1; then
            # Find the most recent inventory directory (highest run number)
            LATEST=$(ls -d inventory-* | sort -t- -k2 -nr | head -n1)
            echo "Using cached inventory from $LATEST"
            cp "$LATEST/inventory-va.json" inventory-va.json 2>/dev/null || echo "No VA inventory cached"
            cp "$LATEST/inventory-nc.json" inventory-nc.json 2>/dev/null || echo "No NC inventory cached"
            ls -lh inventory-*.json 2>/dev/null || echo "No cached inventory files"
          else
            echo "No previous inventory found - will perform full scan"
          fi
        continue-on-error: true

      - name: Run tracker (VA + Wake County)
        run: ./tracker -va -wake
        timeout-minutes: 60

      - name: Prepare deployment with embedded API key
        run: |
          mkdir -p deploy
          # Copy static files
          cp inventory-va.json inventory-nc.json favicon.svg social-preview.svg deploy/
          cp logo*.svg deploy/
          # Inject API key directly into index.html (bypasses Cloudflare Access issue)
          sed 's|<script src="config.js".*</script>|<script>const GOOGLE_MAPS_API_KEY = "${{ secrets.GOOGLE_MAPS_API_KEY }}"; loadGoogleMaps();</script>|' index.html > deploy/index.html
          ls -lah deploy/

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: cask-watch
          directory: deploy
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload inventory artifacts
        uses: actions/upload-artifact@v6
        with:
          name: inventory-${{ github.run_number }}
          path: |
            inventory-va.json
            inventory-nc.json
          retention-days: 7
