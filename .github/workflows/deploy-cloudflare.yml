name: Deploy to Cloudflare Pages

on:
  workflow_dispatch: # Manual trigger
  push:
    branches:
      - main
    paths:
      - 'index.html'
      - 'favicon.svg'
      - 'logo-icon.svg'
      - '.github/workflows/deploy-cloudflare.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download latest inventory artifacts
        uses: dawidd6/action-download-artifact@v12
        with:
          workflow: inventory-refresh.yml
          workflow_conclusion: success
          name_is_regexp: true
          name: inventory-.*
          path: .

      - name: Use most recent inventory artifact
        run: |
          if ls inventory-*/inventory-*.json 1> /dev/null 2>&1; then
            LATEST=$(ls -d inventory-* | sort -t- -k2 -nr | head -n1)
            echo "Using inventory from $LATEST"
            cp "$LATEST/inventory-va.json" inventory-va.json
            cp "$LATEST/inventory-nc.json" inventory-nc.json
            ls -lh inventory-*.json
          else
            echo "No inventory artifacts found. Run the inventory refresh workflow first."
            exit 1
          fi

      - name: Prepare deployment with embedded API key
        run: |
          mkdir -p deploy
          # Copy static files
          cp inventory-va.json inventory-nc.json favicon.svg social-preview.svg deploy/
          cp logo*.svg deploy/
          # Inject API key directly into index.html (bypasses Cloudflare Access issue)
          sed 's|<script src="config.js".*</script>|<script>const GOOGLE_MAPS_API_KEY = "${{ secrets.GOOGLE_MAPS_API_KEY }}"; loadGoogleMaps();</script>|' index.html > deploy/index.html
          ls -lah deploy/

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: cask-watch
          directory: deploy
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
